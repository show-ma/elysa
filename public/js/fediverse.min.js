const fed=getElement("fediverse-comments");if(fed)var commentsLoaded,bskyCommentsLoaded,replies=0,reblogs=0,favourites=0;const mstdRoot=getElement("mastodon-comments"),tootUri=mstdRoot.dataset.uri,respondToVisibility=(e,t)=>{const n=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&t()})});n.observe(e)},cmt=getElement("comments"),i18nReplies=cmt.dataset.i18nReplies,i18nReblogs=cmt.dataset.i18nReblogs,i18nFavourites=cmt.dataset.i18nFavourites,i18nLoading=cmt.dataset.i18nLoading,i18nErr=cmt.dataset.i18nErr,i18nNoComment=cmt.dataset.i18nNoComment,cmtSty=document.createElement("style");if(cmtSty.textContent=`
    #comments noscript {margin:var(--medskip) 0}
    #discussion-starter {margin-bottom:var(--medskip)}
    #mastodon-stats {margin-left:auto}
    #mastodon-comments, #bsky-comments, #fediverse-comments {padding:0;list-style:none;width:var(--golden-ratio)}
    #comments li, #comments li > ul {margin-top:1rem;list-style:none}
    .fediverse-comment {margin:1rem 0 1rem calc(var(--mul) * var(--indent));border-left:3pt solid var(--ac);background:#80808008;padding:1rem 1rem 1ex;overflow:auto}
    .fediverse-comment.bsky {--ac:#1185fe}
    .fediverse-comment.mstd {--ac:#563acc}
    .fediverse-comment > .author > img{margin-right:12pt}
    .fediverse-comment .content {margin-left:4rem;line-height:calc(var(--baselineStretch) * 1.272)}
    .fediverse-comment .par a {max-width:100%;vertical-align:bottom;white-space:break-spaces}
    .fediverse-comment > footer {display:flex;align-items:center;margin-top:1rem;margin-left:3.5rem;white-space:nowrap}
    .fediverse-comment > footer .stat {display:inline-flex;flex-shrink:0;gap:5pt}
    .attachments, #comments > summary {display:flex;overflow:auto}
    .attachments > * {flex-shrink:0;width:100%;height:auto}
    .attachments img {width:100%;height:auto}
    .stat > * {display:inline-flex;align-items:center;padding:2pt;color:var(--mid);gap:2pt}
    .stat > *::before {vertical-align:text-top;font-family:'base-ui'}
    .stat > * > span {font-size:0.8em}
    a.replies.active, a.reblogs.active {color:var(--ac)}
    a.favourites.active {color:var(--i3i)}
    .fediverse-comment .date {margin-left:auto;padding-left:1rem;color:var(--mid);font-size:calc(10pt * var(--fontScale))}
    .bluesky {display:inline-block}
    #join-discussion:hover .blueksy, #join-discussion-bluesky:hover .bluesky {transform-origin:center center;animation:flutter 0.2s alternate infinite}
    @keyframes flutter {from { transform:rotateY(0)}to { transform:rotateY(80deg)}}
    @media only screen and (max-width:960px) {
        .fediverse-comment .content, .fediverse-comment > footer {margin-left:0}
    }
    @media print {
        .fediverse-comment {position:relative;background:none;padding-bottom:0}
        .fediverse-comment .date {position:absolute;top:0;right:0}
        .fediverse-comment .stat {display:none !important}
    }`,document.head.appendChild(cmtSty),commentsLoaded=!1,tootUri){function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}const n=(e,t)=>{const n=e[`${t}_count`];return n>0?"active":""},e=(e,t)=>{const n=e[`${t}_count`];return n>0?n:""},s=t=>`
        <a class="replies ${n(t,"replies")}" href="${t.url}" rel="ugc nofollow" aria-label="${i18nReplies}">
            <span>${e(t,"replies")}</span>
        </a>
        <a class="reblogs ${n(t,"reblogs")}" href="${t.url}/reblogs" rel="nofollow" aria-label="${i18nReblogs}">
            <span>${e(t,"reblogs")}</span>
        </a>
        <a class="favourites ${n(t,"favourites")}" href="${t.url}/favourites" rel="nofollow" aria-label="${i18nFavourites}">
            <span>${e(t,"favourites")}</span>
        </a>`,r=e=>{const t={image:()=>`<a href="${e.url}" rel="nofollow"><img src="${e.preview_url}" alt="${e.description}" loading="lazy" /></a>`,video:()=>`<video controls preload="none"><source src="${e.url}" type="${e.mime_type}"></video>`,gifv:()=>`<video autoplay loop muted playsinline><source src="${e.url}" type="${e.mime_type}"></video>`,audio:()=>`<audio controls><source src="${e.url}" type="${e.mime_type}"></audio>`,default:()=>`<a href="${e.url}" rel="nofollow">${e.type}</a>`};if(t)return`<div class="attachments">`+(t[e.type]||t.default)()+`</div>`},o=e=>`
        <div class="par" data-bionRead-safe>${e.content}</div>
        ${e.media_attachments.map(r).join("")}
    `,i=e=>{let t=`@${e.acct}`;if(!e.acct.includes("@")){const n=new URL(e.url);t+=`@${n.hostname}`}return t},a=(e,t)=>{const n=e.filter(e=>e.in_reply_to_id===t).sort((e,t)=>e.created_at.localeCompare(t.created_at));n.forEach(t=>c(e,t))},t=tootUri.split("/"),c=(e,n)=>{const c=escapeHtml(n.account.display_name);n.account.display_name=c,n.account.emojis.forEach(e=>{n.account.display_name=n.account.display_name.replace(`:${e.shortcode}:`,`<img src="${escapeHtml(e.static_url)}" alt="Emoji ${e.shortcode}" height="20" width="20" />`)});const l=`
        <li data-date="${toISOString(n.created_at)}" id="${n.id}">
            <article class="fediverse-comment mstd">
                <header class="author">
                    <img src="${escapeHtml(n.account.avatar_static)}" height=48 width=48 alt="${i(n.account)}" loading="lazy"/>
                    <a class="has-aria-label" href="${n.account.url}" rel="nofollow" aria-label="${i(n.account)}" aria-description="${c}">
                        <span>${n.account.display_name}</span>
                    </a>
                </header>
                <div class="content">${o(n)}</div>
                <footer>
                    <div class="stat">${s(n)}</div>
                    <a class="date" href="${n.url}" rel="ugc nofollow">
                        <time datetime="${toISOString(n.created_at)}">${n.edited_at?"*":""}${formatDate(n.created_at)}</time>
                    </a>
                </footer>
            </article>
        </li>`,r=typeof DOMPurify!="undefined"?DOMPurify.sanitize(l,{RETURN_DOM_FRAGMENT:!0}):l;if(n.in_reply_to_id===t[4])fed?fed.appendChild(r):mstdRoot.appendChild(r);else{const t=e.find(e=>e.id===n.in_reply_to_id);if(t){const e=document.createElement("ul");getElement(n.in_reply_to_id).appendChild(e).appendChild(r)}}a(e,n.id)},l=async()=>{if(commentsLoaded)return;mstdRoot.innerHTML=i18nLoading;function n(){if(t[0]==="https:"||t[0]==="http:")return"https://"+t[2]+"/api/v1/statuses/"+t[4]}try{const[c,l]=await Promise.all([fetch(n()),fetch(n()+`/context`)]),[i,r]=await Promise.all([c.json(),l.json()]);getElement("mastodon-content").innerHTML=o(i),fed?(replies=replies+e(i,"replies"),reblogs=reblogs+e(i,"reblogs"),favourites=favourites+e(i,"favourites")):getElement("mastodon-stats").innerHTML=s(i),r.descendants?.length>0?(mstdRoot.innerHTML="",a(r.descendants,t[4],0)):fed||(mstdRoot.innerHTML=i18nNoComment),commentsLoaded=!0,mstdRoot.setAttribute("aria-busy","false")}catch(e){console.error(`Mastodon ${i18nErr}`,e),mstdRoot.innerHTML=`Mastodon ${i18nErr} : ${e}`}};respondToVisibility(mstdRoot,l)}const bskyRoot=getElement("bsky-comments");bskyCommentsLoaded=!1;function ToBskyUrl(e){const t=e.split("/");return t[0]==="at:"?"https://bsky.app/profile/"+t[2]+"/post/"+t[4]:e}function ToAtProtoUri(e){const t=e.split("/");return t[0]==="https:"||t[0]==="http:"?"at://"+t[4]+"/app.bsky.feed.post/"+t[6]:e}function ToBskyImgUrl(e,t,n){return`https://cdn.bsky.app/img/${n?"feed_thumbnail":"feed_fullsize"}/plain/${e}/${t}`}function renderMainStat(){getElement("mastodon-stats").innerHTML=`
        <a class="replies ${replies>0?"active":""}" href="${bskyRoot.dataset.uri}" rel="nofollow" aria-label="${i18nReplies}"><span>${replies>0?replies:""}</span></a>
        <a class="reblogs ${reblogs>0?"active":""}" href="${bskyRoot.dataset.uri}/reposted-by" rel="nofollow" aria-label="${i18nReblogs}"><span>${reblogs>0?reblogs:""}</span></a>
        <a class="favourites ${favourites>0?"active":""}" href="${bskyRoot.dataset.uri}/liked-by" rel="nofollow" aria-label="${i18nFavourites}"><span>${favourites>0?favourites:""}</span></a>`}if(bskyRoot){const e=ToAtProtoUri(bskyRoot.dataset.uri),t=async()=>{if(bskyCommentsLoaded)return;try{const n=await fetch("https://public.api.bsky.app/xrpc/app.bsky.feed.getPostThread?uri="+e);if(!n.ok)throw new Error(`HTTP error, status = ${n.status}`);const t=await n.json();if(typeof t.thread.replies!="undefined"&&t.thread.replies.length>0){const e=typeof DOMPurify!="undefined"?DOMPurify.sanitize(renderComments(t.thread),{RETURN_DOM_FRAGMENT:!0}):renderComments(t.thread);fed?(replies=replies+t.thread.post.replyCount,reblogs=reblogs+t.thread.post.repostCount,favourites=favourites+t.thread.post.likeCount,fed.appendChild(e)):(mstdRoot||(getElement("mastodon-content").innerHTML=renderRichText(t.thread.post.record),renderMainStat()),bskyRoot.appendChild(e),bskyRoot.setAttribute("aria-busy","false"))}else fed||(bskyRoot.innerHTML=i18nNoComment);bskyCommentsLoaded=!0}catch(e){console.error(`Bluesky ${i18nErr}`,e),bskyRoot.innerHTML=`Bluesky ${i18nErr} : ${e}`}};function renderComments(e){const t=document.createDocumentFragment();for(const n of e.replies){const o=renderComment(n),s=createElementFromHTML(o);s.querySelector(".rep").appendChild(renderComments(n)),t.appendChild(s)}return t}function createElementFromHTML(e){const t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}function renderRichText(e){let o=`<p>`;const a=new TextEncoder,i=new TextDecoder,t=new Uint8Array(e.text.length*3);a.encodeInto(e.text.replace(/\n/g,"<br />"),t);var s,n=0;for(const l in e.facets){const a=e.facets[l],r=a.features[0],c=r.$type;if(s="#",c=="app.bsky.richtext.facet#tag"?s=`https://bsky.app/hashtag/${r.tag}`:c=="app.bsky.richtext.facet#link"?s=r.uri:c=="app.bsky.richtext.facet#mention"&&(s=`https://bsky.app/profile/${r.did}`),n<a.index.byteStart){const e=t.slice(n,a.index.byteStart);o+=i.decode(e)}const d=t.slice(a.index.byteStart,a.index.byteEnd);o+=`<a href="${s}" target="_blank">`+i.decode(d)+"</a>",n=a.index.byteEnd}if(n<t.length){const e=t.slice(n,t.length);o+=i.decode(e)}return o+"</p>"}function renderAttachment(e){let t="";const n=e.author.did;if(e.embed){const s=e.embed.$type;if(s==="app.bsky.embed.external#view"){const{uri:n,title:s,description:o}=e.embed.external;n.includes(".gif?")&&(t=`<img src="${n}" title="${s}" alt="${o}" loading="lazy">`)}else if(s==="app.bsky.embed.images#view"){const s=e.record.embed.images;t=s.map(e=>{const t=ToBskyImgUrl(n,e.image.ref.$link,!0),s=ToBskyImgUrl(n,e.image.ref.$link,!1);return`<a href="${s}" target="_blank"><img src="${t}" alt="${e.alt}" loading="lazy"></a>`}).join("")}else if(s==="app.bsky.embed.video#view"){const s=e.record.embed.video;t=`<video controls poster="${e.embed.thumbnail}" preload="none">
                    <source src="https://bsky.social/xrpc/com.atproto.sync.getBlob?cid=${s.ref.$link}&did=${n}" type="${s.mimeType}"></video>`}return`<div class="attachments">`+t+`</div>`}return t}function renderComment(e){const t=new Date(e.post.record.createdAt);return`
        <li data-date="${toISOString(t)}" id="${e.post.cid}">
            <article class="fediverse-comment bsky" style="margin-bottom: 1rem">
            <header class="author">
                <img src="${e.post.author.avatar}" width=58 height=48 alt="${e.post.author.handle}" loading="lazy" />
                <a class="has-aria-label" href="https://bsky.app/profile/${e.post.author.handle}" rel="ugc" aria-label="@${e.post.author.handle}" aria-description="${e.post.author.displayName}">
                    <span>${e.post.author.displayName}</span>
                </a>
            </header>
            <div class="content">
                <div class="par" data-bionRead-safe>${renderRichText(e.post.record)}</div>
                ${renderAttachment(e.post)}
            </div>
            <footer>
                <div class="stat">
                <a class="replies ${e.post.replyCount>0?"active":""}" href="${ToBskyUrl(e.post.uri)}" rel="ugc nofollow"  aria-label="${i18nReplies}">
                    <span>${e.post.replyCount>0?e.post.replyCount:""}</span>
                </a>
                <a class="reblogs ${e.post.repostCount>0?"active":""}" href="${ToBskyUrl(e.post.uri)}/reposted-by" rel="nofollow" aria-label="${i18nReblogs}">
                    <span>${e.post.repostCount>0?e.post.repostCount:""}</span>
                </a>
                <a class="favourites ${e.post.likeCount>0?"active":""}" href="${ToBskyUrl(e.post.uri)}/liked-by" rel="nofollow" aria-label="${i18nFavourites}">
                    <span>${e.post.likeCount>0?e.post.likeCount:""}</span>
                </a>
                </div>
                <a class="date" href="${ToBskyUrl(e.post.uri)}" rel="ugc nofollow"><time datetime="${toISOString(t)}">${formatDate(t)}</time></a>
            </footer>
            </article>
            <ul class="rep"></ul>
        </li>`}respondToVisibility(bskyRoot,t)}function aggregateComment(){if(commentsLoaded&&bskyCommentsLoaded){const t=Array.from(document.querySelectorAll("#fediverse-comments > li[data-date]")),e=new Set;t.sort(({dataset:{date:e}},{dataset:{date:t}})=>e.localeCompare(t)).forEach(t=>{e.has(t.id)?t.remove():(e.add(t.id),t.parentNode.appendChild(t))}),renderMainStat(),bskyRoot.remove(),mstdRoot.remove()}else window.setTimeout(aggregateComment,100)}bskyRoot&&mstdRoot&&aggregateComment()